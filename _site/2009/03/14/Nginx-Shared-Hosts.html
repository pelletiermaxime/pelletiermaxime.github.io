<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN"
    "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">

<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en-us">
<head>
   <meta http-equiv="content-type" content="text/html; charset=utf-8" />
   <title>Configuring Nginx to do shared hosting or virtual hosts</title>
   <meta name="author" content="Maxime Pelletier" />

   <!-- syntax highlighting CSS -->
   <link rel="stylesheet" href="/css/syntax.css" type="text/css" />

   <!-- Homepage CSS -->
   <link rel="stylesheet" href="/css/screen.css" type="text/css" media="screen, projection" />
</head>
<body>

<div class="site">
  <div class="title">
    <a href="/">Maxime Pelletier</a>
    <a class="extra" href="/">home</a>
  </div>

  <div id="post">
<h1 id="configuring-nginx-to-do-shared-hosting-or-virtual-hosts">Configuring Nginx to do shared hosting or virtual hosts</h1>

<p>I host multiple websites on the same server and I was tired to do server sections in my nginx config,
so I created a config that catches all domains and point to a directory. Heres my config and I will
explain it after.</p>

<pre><code>server {
            if ($host ~* www\.(.*)) {
                    set $host_without_www $1;
                    rewrite ^(.*)$ http://$host_without_www$1/ permanent;
            }
            server_name_in_redirect off; #or folders like /awstats will redirect to _
            listen 80;
            server_name _;
            access_log      /var/log/nginx/$host.access_log main;
            error_log      /var/log/nginx/$host.access_log info;
            root /var/www/$host/htdocs;
            location ~ \.php$ {
                    include /etc/nginx/fastcgi_params;
                    fastcgi_pass  127.0.0.1:1026;
                    fastcgi_index index.php;
            }
	#For WP
            if (!-e $request_filename) {
                    rewrite ^(.+)$ /index.php?q=$1 last;
            }
    }
</code></pre>

<p>Here is a detailed explanation of the config, as best as I can describe it.</p>

<pre><code>if ($host ~* www\.(.*)) {
    	set $host_without_www $1;
            rewrite ^(.*)$ http://$host_without_www$1/ permanent;
    }
</code></pre>

<p>Assign the variable host_without_www and then rewrite to stip all the www. Without those lines, www.domain.com and domain.com 
would be considered 2 different domains.</p>

<pre><code>server_name_in_redirect off; #or folders like /awstats will redirect to _
</code></pre>

<p>Like my comment says, without this line, domain.com/directory would redirect to _ (the server name).</p>

<pre><code>listen 80;
    server_name _;
    access_log      /var/log/nginx/$host.access_log main;
    error_log      /var/log/nginx/$host.access_log info;
    root /var/www/$host/htdocs;
</code></pre>

<p>The key part of this config is the server_name. _ is a catch all that catches every domain name. Then, the variable $host 
contain the actual domain name. For exemple, for this site the access log would be 
/var/log/nginx/pelletiermaxime.info.access_log. The root line tells nginx to use /var/www/pelletiermaxime.info/htdocs as the 
server root.</p>

<pre><code>location ~ \.php$ {
    	include /etc/nginx/fastcgi_params;
            fastcgi_pass  127.0.0.1:1026;
            fastcgi_index index.php;
    }
#For WP
    if (!-e $request_filename) {
    	rewrite ^(.+)$ /index.php?q=$1 last;
    }
</code></pre>

<p>This is the standard config to pass requests to the php cgi and to rewrite urls for my wordpress blog. </p>

<p>If you have questions or suggestions of how to do this better or comments, just ask.</p>

</div>

<div id="related">
  <h2>Related Posts</h2>
  <ul class="posts">
    
      <li><span>10 Dec 2011</span> &raquo; <a href="/2011/12/10/Dislike-About_web.html">What I don't like about web programming</a></li>
    
      <li><span>24 Jun 2009</span> &raquo; <a href="/2009/06/24/Laconica-Stats-Plugin-3.html">Stats plugin for laconica version 0.3</a></li>
    
      <li><span>16 Jun 2009</span> &raquo; <a href="/2009/06/16/Laconica-Stats-Plugin-2.html">Stats plugin for laconica version 0.2</a></li>
    
  </ul>
</div>
<div id="disqus_thread"></div>
<script type="text/javascript" src="http://disqus.com/forums/pelletiermaxime/embed.js"></script>
<noscript><a href="http://pelletiermaxime.disqus.com/?url=ref">View the discussion thread.</a></noscript>



  <div class="footer">
    <div class="contact">
      <p>
        Maxime Pelletier<br />
      </p>
    </div>
    <div class="contact">
      <p>
        <a href="https://twitter.com/pelletiermaxime">twitter.com/pelletiermaxime</a><br />
      </p>
    </div>
    <div class="rss">
      <a href="/atom.xml">
        <img src="/images/rss.png" alt="Subscribe to RSS Feed" />
      </a>
    </div>
  </div>
</div>
</body>
</html>

